<% content_for :title, "Candidature soumise - #{@public_market.title}" %>

<!-- Step Indicator -->
<ol class="step-indicator">
  <li class="completed">Information du march√©</li>
  <li class="completed">Identification</li>
  <li class="completed">Formulaire</li>
  <li class="active">Confirmation</li>
</ol>

<div class="candidate-card">
  <div class="candidate-card-header" style="text-align: center;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
    <h2 style="margin: 0; font-size: 1.75rem; color: #059669;">
      Candidature soumise avec succ√®s !
    </h2>
    <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 1.125rem;">
      Votre candidature a √©t√© enregistr√©e et transmise
    </p>
  </div>
  
  <div class="candidate-card-body">
    <!-- Submission Details -->
    <div style="background-color: #d1fae5; border: 1px solid #a7f3d0; border-radius: 0.5rem; padding: 2rem; margin-bottom: 2rem; text-align: center;">
      <h3 style="margin: 0 0 1.5rem 0; color: #065f46; font-size: 1.25rem;">
        üìã D√©tails de votre soumission
      </h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
        <div>
          <strong style="color: #065f46;">ID de soumission</strong><br>
          <code style="background-color: #a7f3d0; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 1.125rem; color: #065f46; font-weight: bold;">
            <%= @application.submission_id %>
          </code>
        </div>
        
        <div>
          <strong style="color: #065f46;">Date de soumission</strong><br>
          <span style="font-size: 1.125rem; color: #059669;">
            <%= @application.submitted_at.strftime("%d/%m/%Y √† %H:%M:%S") %>
          </span>
        </div>
        
        <div>
          <strong style="color: #065f46;">SIRET</strong><br>
          <span style="font-size: 1.125rem; color: #059669; font-family: monospace;">
            <%= @application.formatted_siret %>
          </span>
        </div>
      </div>
      
      <p style="margin: 0; color: #065f46; font-size: 0.875rem;">
        <strong>Conservez pr√©cieusement cet ID de soumission</strong> - il constitue votre preuve de candidature
      </p>
    </div>

    <!-- Market Information Recap -->
    <div style="background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.125rem;">
        üèõÔ∏è R√©capitulatif du march√©
      </h3>
      
      <div style="display: grid; gap: 1rem;">
        <div>
          <strong>March√© :</strong>
          <span style="margin-left: 0.5rem; color: #4b5563;"><%= @public_market.title %></span>
        </div>
        
        <div>
          <strong>Type :</strong>
          <span style="margin-left: 0.5rem; color: #4b5563;">
            <%= case @public_market.market_type
                when 'supplies' then 'Fournitures'
                when 'services' then 'Services'
                when 'works' then 'Travaux'
                end %>
          </span>
        </div>
        
        <div>
          <strong>Date limite :</strong>
          <span style="margin-left: 0.5rem; color: #4b5563;">
            <%= @public_market.deadline.strftime("%d/%m/%Y √† %H:%M") %>
          </span>
        </div>
        
        <div>
          <strong>Fast Track ID :</strong>
          <code style="background-color: #e5e7eb; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem;">
            <%= @public_market.fast_track_id %>
          </code>
        </div>
      </div>
    </div>

    <!-- Critical Download Section -->
    <div style="background-color: #fef2f2; border: 2px solid #fca5a5; border-radius: 0.5rem; padding: 2rem; margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
        <div style="font-size: 2rem; margin-right: 1rem;">‚ö†Ô∏è</div>
        <div>
          <h3 style="margin: 0; color: #991b1b; font-size: 1.25rem;">
            IMPORTANT : T√©l√©chargez votre attestation
          </h3>
          <p style="margin: 0.5rem 0 0 0; color: #7f1d1d;">
            Cette attestation est votre <strong>preuve officielle</strong> de candidature
          </p>
        </div>
      </div>
      
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <%= link_to candidate_download_attestation_path(fast_track_id: @public_market.fast_track_id), 
            class: "btn btn-primary btn-large",
            style: "background-color: #dc2626; border-color: #dc2626; font-size: 1.125rem; padding: 1rem 2rem;",
            target: "_blank" do %>
          üìÑ T√©l√©charger l'attestation PDF
        <% end %>
      </div>
      
      <div style="background-color: #fee2e2; border-radius: 0.375rem; padding: 1rem;">
        <h4 style="margin: 0 0 0.5rem 0; color: #991b1b; font-size: 1rem;">
          Pourquoi t√©l√©charger cette attestation ?
        </h4>
        <ul style="margin: 0; padding-left: 1.5rem; color: #7f1d1d; font-size: 0.875rem;">
          <li>Elle fait foi de la r√©ception de votre candidature par l'administration</li>
          <li>Elle contient l'horodatage officiel de votre soumission</li>
          <li>Elle peut √™tre exig√©e en cas de litige ou de v√©rification</li>
          <li>Elle constitue votre accus√© de r√©ception officiel</li>
        </ul>
      </div>
    </div>

    <!-- Next Steps -->
    <div style="background-color: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1.125rem;">
        üìã √âtapes suivantes
      </h3>
      
      <div style="display: grid; gap: 1rem;">
        <div style="display: flex; align-items: start;">
          <div style="background-color: #3b82f6; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: bold; margin-right: 1rem; flex-shrink: 0;">1</div>
          <div>
            <strong style="color: #1e40af;">T√©l√©chargez votre attestation</strong><br>
            <span style="color: #1e3a8a; font-size: 0.875rem;">Conservez-la comme preuve de votre candidature</span>
          </div>
        </div>
        
        <div style="display: flex; align-items: start;">
          <div style="background-color: #3b82f6; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: bold; margin-right: 1rem; flex-shrink: 0;">2</div>
          <div>
            <strong style="color: #1e40af;">Surveillez vos e-mails</strong><br>
            <span style="color: #1e3a8a; font-size: 0.875rem;">Vous recevrez les communications officielles sur <%= @application.email %></span>
          </div>
        </div>
        
        <div style="display: flex; align-items: start;">
          <div style="background-color: #3b82f6; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: bold; margin-right: 1rem; flex-shrink: 0;">3</div>
          <div>
            <strong style="color: #1e40af;">Attendez la r√©ponse</strong><br>
            <span style="color: #1e3a8a; font-size: 0.875rem;">Les r√©sultats de la proc√©dure vous seront communiqu√©s selon le calendrier pr√©vu</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact Support -->
    <div style="background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.125rem;">
        üí¨ Besoin d'aide ?
      </h3>
      
      <p style="margin: 0 0 1rem 0; color: #4b5563;">
        Si vous avez des questions concernant votre candidature ou la proc√©dure :
      </p>
      
      <ul style="margin: 0; padding-left: 1.5rem; color: #4b5563;">
        <li>Contactez l'organisme responsable du march√©</li>
        <li>Mentionnez toujours votre ID de soumission : <strong><%= @application.submission_id %></strong></li>
        <li>Conservez une copie de tous vos documents</li>
      </ul>
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
      <%= link_to candidate_download_attestation_path(fast_track_id: @public_market.fast_track_id), 
          class: "btn btn-primary",
          target: "_blank" do %>
        üìÑ T√©l√©charger l'attestation
      <% end %>
      
      <button type="button" onclick="window.print()" class="btn btn-secondary">
        üñ®Ô∏è Imprimer cette page
      </button>
      
      <% if platform_callback_url.present? %>
        <form method="get" action="<%= platform_callback_url %>" style="display: inline;" data-turbo="false" id="callback-form">
          <input type="hidden" name="fast_track_id" value="<%= @public_market.fast_track_id %>">
          <input type="hidden" name="siret" value="<%= @application.siret %>">
          <input type="hidden" name="status" value="completed">
          <input type="hidden" name="company_name" value="<%= @application.company_name %>">
          <input type="hidden" name="submitted_at" value="<%= @application.submitted_at.iso8601 %>">
          <% if session[:platform_state].present? %>
            <input type="hidden" name="state" value="<%= session[:platform_state] %>">
          <% end %>
          <button type="submit" class="btn btn-outline" onclick="logCallbackDetails(event)">
            ‚Üê Retour √† la plateforme
          </button>
        </form>
        
        <script>
          function logCallbackDetails(event) {
            console.log('üöÄ CALLBACK FORM SUBMISSION DEBUG');
            const form = document.getElementById('callback-form');
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);
            
            console.log('Form action:', form.action);
            console.log('Form method:', form.method);
            console.log('Parameters:');
            for (let [key, value] of params) {
              console.log(`  ${key}: ${value}`);
            }
            console.log('Full URL will be:', form.action + '?' + params.toString());
            console.log('Browser will navigate to this URL in 1 second...');
            
            // Allow the form to submit normally
            return true;
          }
        </script>
      <% end %>
    </div>

    <!-- Platform Integration Information -->
    <% if platform_callback_url.present? %>
      <div style="margin-top: 2rem; padding: 1rem; background-color: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; text-align: center;">
        <p style="margin: 0; color: #1e40af; font-size: 0.875rem;">
          üì± Int√©gration plateforme d√©tect√©e - Vous pouvez retourner √† la plateforme d'origine
        </p>
      </div>
      
      <!-- Enhanced Debug callback information -->
      <div style="margin-top: 1rem; padding: 1rem; background-color: #f0f0f0; border-radius: 0.5rem; font-size: 0.8rem; font-family: monospace;">
        <strong>üîç Callback Debug Information:</strong><br><br>
        
        <strong>URL & Routing:</strong><br>
        Callback URL: <code><%= platform_callback_url %></code><br>
        Form Action: <code><%= platform_callback_url %></code><br>
        Form Method: GET<br><br>
        
        <strong>Session Data:</strong><br>
        Platform State: <code><%= session[:platform_state] %></code><br>
        Platform Callback URL: <code><%= session[:platform_callback_url] %></code><br>
        Session ID: <code><%= session.id %></code><br><br>
        
        <strong>Application Data:</strong><br>
        Fast Track ID: <code><%= @public_market.fast_track_id %></code><br>
        Application SIRET: <code><%= @application.siret %></code><br>
        Company Name: <code><%= @application.company_name %></code><br>
        Submitted At: <code><%= @application.submitted_at.iso8601 %></code><br>
        Status: <code>completed</code><br><br>
        
        <strong>All Form Parameters:</strong><br>
        <code>
        fast_track_id=<%= @public_market.fast_track_id %><br>
        siret=<%= @application.siret %><br>
        status=completed<br>
        company_name=<%= @application.company_name %><br>
        submitted_at=<%= @application.submitted_at.iso8601 %><br>
        <% if session[:platform_state].present? %>state=<%= session[:platform_state] %><br><% end %>
        </code><br>
        
        <strong>Expected Editor App Route:</strong><br>
        <code>GET /candidate/fasttrack_callback</code><br><br>
        
        <strong>Environment:</strong><br>
        Current Time: <code><%= Time.current.iso8601 %></code><br>
        Rails Env: <code><%= Rails.env %></code><br>
        Fast Track Host: <code><%= request.host_with_port %></code><br>
        
        <% if defined?(ENV['EDITOR_BASE_URL']) %>
        Editor Base URL: <code><%= ENV['EDITOR_BASE_URL'] %></code><br>
        <% end %>
      </div>
    <% end %>

    <!-- Technical Information -->
    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; text-align: center;">
      <p class="text-sm text-muted">
        Soumission effectu√©e via Fast Track - R√©publique Fran√ßaise<br>
        Horodatage : <%= @application.submitted_at.iso8601 %><br>
        Cette page peut √™tre conserv√©e comme preuve de soumission
      </p>
    </div>
  </div>
</div>

<script type="application/javascript">
  document.addEventListener('turbo:load', function() {
    // Auto-focus on download button
    const downloadButton = document.querySelector('a[href*="download_attestation"]');
    if (downloadButton) {
      downloadButton.focus();
    }
    
    // Show reminder after 30 seconds if still on page
    setTimeout(() => {
      if (document.visibilityState === 'visible') {
        const reminder = document.createElement('div');
        reminder.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background-color: #dc2626;
          color: white;
          padding: 1rem;
          border-radius: 0.5rem;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          z-index: 1000;
          max-width: 300px;
        `;
        reminder.innerHTML = `
          <strong>‚ö†Ô∏è N'oubliez pas !</strong><br>
          T√©l√©chargez votre attestation avant de fermer cette page.
          <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">√ó</button>
        `;
        document.body.appendChild(reminder);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
          if (reminder.parentElement) {
            reminder.remove();
          }
        }, 10000);
      }
    }, 30000);
  });
</script>

<style>
  @media print {
    .btn {
      display: none;
    }
    
    .step-indicator {
      display: none;
    }
    
    body {
      font-size: 12pt;
      line-height: 1.4;
    }
    
    .candidate-card {
      box-shadow: none;
      border: 1px solid #000;
    }
  }
</style>