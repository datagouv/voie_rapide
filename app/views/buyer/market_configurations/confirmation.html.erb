<% content_for :title, "Configuration termin√©e - Fast Track" %>

<div data-controller="confirmation"
     data-confirmation-fast-track-id-value="<%= @public_market.fast_track_id %>"
     data-confirmation-market-title-value="<%= @public_market.title %>"
     data-confirmation-deadline-value="<%= @public_market.deadline.iso8601 %>"
     data-confirmation-documents-count-value="<%= @document_requirements.count %>">
  <!-- Step Indicator -->
  <ol class="step-indicator">
    <li class="completed">Type de march√©</li>
    <li class="completed">Documents requis</li>
    <li class="active">Confirmation</li>
  </ol>

  <!-- Success Message -->
  <div class="alert alert-success">
    <div style="display: flex; align-items: center;">
      <span style="font-size: 1.5rem; margin-right: 0.75rem;">‚úÖ</span>
      <div>
        <strong>Configuration Fast Track termin√©e avec succ√®s !</strong><br>
        Votre march√© est maintenant configur√© et pr√™t √† recevoir des candidatures.
      </div>
    </div>
  </div>

  <!-- Market Information Summary -->
  <div style="margin-bottom: 2rem;">
    <h1 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">
      R√©capitulatif de la configuration
    </h1>
    
    <div style="background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
      <div style="display: grid; gap: 1rem;">
        <div>
          <div class="text-sm" style="color: #6b7280; margin-bottom: 0.25rem;">
            Titre du march√©
          </div>
          <div style="font-weight: 600;">
            <%= @public_market.title %>
          </div>
        </div>
        
        <div>
          <div class="text-sm" style="color: #6b7280; margin-bottom: 0.25rem;">
            Type de march√©
          </div>
          <div style="font-weight: 600;">
            <%= case @public_market.market_type
                when 'supplies' then 'Fournitures'
                when 'services' then 'Services'
                when 'works' then 'Travaux'
                end %>
          </div>
        </div>
        
        <div>
          <div class="text-sm" style="color: #6b7280; margin-bottom: 0.25rem;">
            Date limite de candidature
          </div>
          <div style="font-weight: 600;">
            <%= @public_market.deadline.strftime("%d/%m/%Y √† %H:%M") %>
          </div>
        </div>
        
        <div>
          <div class="text-sm" style="color: #6b7280; margin-bottom: 0.25rem;">
            Documents requis
          </div>
          <div style="font-weight: 600;">
            <%= @document_requirements.count %> document(s) au total
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fast Track ID -->
  <div style="margin-bottom: 2rem;">
    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">
      Identifiant Fast Track
    </h2>
    
    <div style="background-color: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; padding: 1.5rem;">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <div class="text-sm" style="color: #0369a1; margin-bottom: 0.5rem;">
            ID Fast Track g√©n√©r√© :
          </div>
          <div class="fast-track-id" style="font-size: 1.125rem;">
            <%= @public_market.fast_track_id %>
          </div>
        </div>
        <button type="button" 
                onclick="navigator.clipboard.writeText('<%= @public_market.fast_track_id %>')"
                style="padding: 0.5rem; background: #2563eb; color: white; border: none; border-radius: 0.25rem; cursor: pointer;"
                title="Copier l'ID">
          üìã
        </button>
      </div>
      <div class="text-sm" style="color: #0369a1; margin-top: 1rem;">
        <strong>Important :</strong> Conservez cet identifiant pour r√©f√©rence. 
        Il sera utilis√© par votre plateforme pour recevoir les candidatures.
      </div>
    </div>
  </div>

  <!-- Document Requirements Summary -->
  <div style="margin-bottom: 2rem;">
    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">
      Documents configur√©s
    </h2>
    
    <div class="document-list">
      <% @document_requirements.each do |document| %>
        <% config = document.public_market_configurations.find { |c| c.public_market_id == @public_market.id } %>
        <div class="document-item <%= 'mandatory' if config&.required? %>">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div style="font-weight: 600;">
                <%= document.nom %>
              </div>
              <span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 9999px; font-weight: 600; 
                           <%= if config&.required?
                                 'background-color: #dcfce7; color: #166534;'
                               else
                                 'background-color: #fef3c7; color: #92400e;'
                               end %>">
                <%= config&.required? ? 'OBLIGATOIRE' : 'OPTIONNEL' %>
              </span>
            </div>
            <% if document.description.present? %>
              <div class="text-sm" style="margin-top: 0.25rem;">
                <%= document.description %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Next Steps Information -->
  <div style="background-color: #fffbeb; border: 1px solid #fed7aa; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
    <h3 style="font-size: 1.125rem; font-weight: 600; color: #92400e; margin-bottom: 1rem;">
      Prochaines √©tapes
    </h3>
    <ol style="color: #92400e; margin-left: 1.5rem;">
      <li style="margin-bottom: 0.5rem;">
        Votre plateforme va recevoir l'ID Fast Track : <strong><%= @public_market.fast_track_id %></strong>
      </li>
      <li style="margin-bottom: 0.5rem;">
        Les entreprises pourront candidater via Fast Track jusqu'au <%= @public_market.deadline.strftime("%d/%m/%Y √† %H:%M") %>
      </li>
      <li style="margin-bottom: 0.5rem;">
        Vous recevrez les candidatures sous forme de dossiers ZIP via votre plateforme
      </li>
      <li>
        Chaque candidature inclura une attestation PDF officielle avec horodatage
      </li>
    </ol>
  </div>

  <!-- Actions -->
  <div style="text-align: center;">
    <% callback_data = session[:platform_callback] %>
    
    <!-- Debug session data -->
    <div style="background: #f0f0f0; padding: 1rem; margin: 1rem 0; font-size: 0.8rem; border-radius: 4px;">
      <strong>Session Debug Info:</strong><br>
      callback_data: <%= callback_data.inspect %><br>
      callback_data present: <%= callback_data.present? %><br>
      callback_data url: <%= callback_data&.dig('url').inspect %><br>
      Session keys: <%= session.keys.inspect %><br>
      Session ID: <%= session.id %>
    </div>
    
    <% if callback_data&.dig('url').present? %>
      <form method="get" action="<%= callback_data['url'] %>" style="display: inline;" data-turbo="false">
        <input type="hidden" name="fast_track_id" value="<%= @public_market.fast_track_id %>">
        <input type="hidden" name="market_title" value="<%= @public_market.title %>">
        <input type="hidden" name="deadline" value="<%= @public_market.deadline&.iso8601 %>">
        <input type="hidden" name="documents_count" value="<%= @document_requirements.count %>">
        <% if callback_data['state'].present? %>
          <input type="hidden" name="state" value="<%= callback_data['state'] %>">
        <% end %>
        <button type="submit" class="btn btn-primary" style="min-width: 200px;"
                onclick="console.log('Submitting callback to:', '<%= callback_data['url'] %>'); 
                         console.log('Form data:', { fast_track_id: '<%= @public_market.fast_track_id %>', state: '<%= callback_data['state'] %>' });
                         return true;">
          Retour √† la plateforme
        </button>
      </form>
      
      <script>
        // Debug: Log callback data to console
        console.log('Fast Track callback will be sent to:', '<%= callback_data['url'] %>');
        console.log('Fast Track ID:', '<%= @public_market.fast_track_id %>');
        console.log('State parameter:', '<%= callback_data['state'] %>');
      </script>
      
      <!-- Debug info (remove in production) -->
      <div style="background: #f0f0f0; padding: 1rem; margin-top: 1rem; font-size: 0.8rem; border-radius: 4px;">
        <strong>Debug Info:</strong><br>
        Callback URL: <%= callback_data['url'] %><br>
        State: <%= callback_data['state'] %>
      </div>
    <% else %>
      <button type="button" 
              onclick="handleReturnToPlatform()" 
              class="btn btn-primary"
              style="min-width: 200px;">
        Retour √† la plateforme
      </button>
      
      <script>
        function handleReturnToPlatform() {
          // No callback data available, try to close or redirect to editor
          try {
            // First, try to close the window (works if opened by script)
            window.close();
            
            // If we're still here after a brief delay, the close didn't work
            setTimeout(function() {
              if (!window.closed) {
                // Redirect to the editor app's main page as fallback
                window.location.href = '<%= ENV.fetch("EDITOR_BASE_URL", "http://localhost:4000") %>';
              }
            }, 100);
          } catch (e) {
            // If close() throws an error, redirect immediately
            window.location.href = '<%= ENV.fetch("EDITOR_BASE_URL", "http://localhost:4000") %>';
          }
        }
      </script>
    <% end %>
    <div class="text-sm" style="margin-top: 1rem; color: #6b7280;">
      Configuration termin√©e avec succ√®s
    </div>
  </div>
</div>

