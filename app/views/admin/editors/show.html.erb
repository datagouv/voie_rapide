<% content_for :title, "#{@editor.name} - √âditeur Fast Track" %>

<div class="admin-header">
  <h1><%= @editor.name %></h1>
  <div class="header-actions">
    <%= link_to "Modifier", edit_admin_editor_path(@editor), class: "btn btn-outline-primary" %>
    <%= link_to "‚Üê Tous les √©diteurs", admin_editors_path, class: "btn btn-outline-secondary" %>
  </div>
</div>

<div class="editor-details">
  <!-- Basic Information -->
  <div class="detail-section">
    <h2>Informations G√©n√©rales</h2>
    <div class="detail-grid">
      <div class="detail-item">
        <label>Nom de l'√©diteur</label>
        <span><%= @editor.name %></span>
      </div>
      
      <div class="detail-item">
        <label>Callback URL</label>
        <span>
          <%= link_to @editor.callback_url, @editor.callback_url, 
              target: "_blank", class: "external-link" %>
        </span>
      </div>
      
      <div class="detail-item">
        <label>Statut d'autorisation</label>
        <span>
          <% if @editor.authorized? %>
            <span class="status-badge status-success">‚úÖ Autoris√©</span>
          <% else %>
            <span class="status-badge status-warning">‚ö†Ô∏è Non autoris√©</span>
          <% end %>
        </span>
      </div>
      
      <div class="detail-item">
        <label>Statut d'activit√©</label>
        <span>
          <% if @editor.active? %>
            <span class="status-badge status-success">‚úÖ Actif</span>
          <% else %>
            <span class="status-badge status-warning">‚ö†Ô∏è Inactif</span>
          <% end %>
        </span>
      </div>
    </div>
  </div>

  <!-- OAuth Configuration -->
  <div class="detail-section">
    <h2>Configuration OAuth2</h2>
    
    <% if @doorkeeper_app %>
      <div class="oauth-configured">
        <div class="status-badge status-success">
          ‚úÖ Application OAuth configur√©e
        </div>
        
        <div class="oauth-details">
          <div class="oauth-item">
            <label>Client ID</label>
            <div class="code-block">
              <code><%= @editor.client_id %></code>
              <button onclick="copyToClipboard('<%= @editor.client_id %>')" class="copy-btn" title="Copier">
                üìã
              </button>
            </div>
          </div>
          
          <div class="oauth-item">
            <label>Client Secret</label>
            <div class="code-block">
              <code id="client-secret" data-secret="<%= @editor.client_secret %>">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
              <button onclick="toggleSecret()" class="copy-btn" title="Afficher/Masquer">
                üëÅÔ∏è
              </button>
              <button onclick="copyToClipboard('<%= @editor.client_secret %>')" class="copy-btn" title="Copier">
                üìã
              </button>
            </div>
            <small class="warning-text">
              ‚ö†Ô∏è Gardez ce secret confidentiel. Ne le partagez jamais publiquement.
            </small>
          </div>
          
          <div class="oauth-item">
            <label>Scopes autoris√©s</label>
            <div class="scopes-list">
              <span class="scope-badge">market_config</span>
              <span class="scope-badge">market_read</span>
              <span class="scope-badge">application_read</span>
            </div>
          </div>
          
          <div class="oauth-item">
            <label>URL de redirection autoris√©e</label>
            <div class="code-block">
              <code><%= @doorkeeper_app.redirect_uri %></code>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="oauth-missing">
        <div class="status-badge status-warning">
          ‚ö†Ô∏è Application OAuth non configur√©e
        </div>
        <p>Cette configuration OAuth est n√©cessaire pour permettre √† l'√©diteur de s'authentifier avec Fast Track.</p>
        <%= link_to "Configurer OAuth", sync_doorkeeper_admin_editor_path(@editor), 
            method: :patch, class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>

  <!-- Integration Information -->
  <% if @doorkeeper_app %>
    <div class="detail-section">
      <h2>Informations d'Int√©gration</h2>
      
      <div class="integration-info">
        <h3>URLs Fast Track</h3>
        <div class="url-list">
          <div class="url-item">
            <label>Authorization URL</label>
            <div class="code-block">
              <code>/oauth/authorize?client_id=<%= @editor.client_id %>&redirect_uri=<%= @doorkeeper_app.redirect_uri %>&response_type=code&scope=market_config</code>
              <button onclick="copyToClipboard('/oauth/authorize?client_id=<%= @editor.client_id %>&redirect_uri=<%= @doorkeeper_app.redirect_uri %>&response_type=code&scope=market_config')" class="copy-btn">üìã</button>
            </div>
          </div>
          
          <div class="url-item">
            <label>Token URL</label>
            <div class="code-block">
              <code>/oauth/token</code>
              <button onclick="copyToClipboard('/oauth/token')" class="copy-btn">üìã</button>
            </div>
          </div>
          
          <div class="url-item">
            <label>Fast Track Configuration URL</label>
            <div class="code-block">
              <code>/buyer/market_configurations/new</code>
              <button onclick="copyToClipboard('/buyer/market_configurations/new')" class="copy-btn">üìã</button>
            </div>
          </div>
        </div>
        
        <div class="integration-example">
          <h4>Exemple d'int√©gration (JavaScript)</h4>
          <div class="code-block code-example">
<pre><code>// 1. Rediriger vers Fast Track pour OAuth
window.location.href = '/oauth/authorize?' + new URLSearchParams({
  client_id: '<%= @editor.client_id %>',
  redirect_uri: '<%= @doorkeeper_app.redirect_uri %>',
  response_type: 'code',
  scope: 'market_config'
});

// 2. √âchanger le code contre un token
const tokenResponse = await fetch('/oauth/token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    grant_type: 'authorization_code',
    client_id: '<%= @editor.client_id %>',
    client_secret: '<%= @editor.client_secret %>',
    code: authorizationCode,
    redirect_uri: '<%= @doorkeeper_app.redirect_uri %>'
  })
});

// 3. Ouvrir Fast Track avec le token
const iframe = document.createElement('iframe');
iframe.src = '/buyer/market_configurations/new?access_token=' + accessToken;
document.body.appendChild(iframe);</code></pre>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Statistics -->
  <div class="detail-section">
    <h2>Statistiques</h2>
    <div class="stats-grid">
      <div class="stat-item">
        <span class="stat-number"><%= @editor.public_markets.count %></span>
        <span class="stat-label">March√©s configur√©s</span>
      </div>
      
      <div class="stat-item">
        <span class="stat-number"><%= @editor.public_markets.joins(:applications).count %></span>
        <span class="stat-label">Candidatures re√ßues</span>
      </div>
      
      <div class="stat-item">
        <span class="stat-number"><%= time_ago_in_words(@editor.created_at) %></span>
        <span class="stat-label">Cr√©√© il y a</span>
      </div>
    </div>
  </div>
</div>

<script>
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      // Visual feedback
      event.target.innerHTML = '‚úÖ';
      setTimeout(() => {
        event.target.innerHTML = 'üìã';
      }, 1000);
    });
  }
  
  function toggleSecret() {
    const secretElement = document.getElementById('client-secret');
    const secret = secretElement.dataset.secret;
    
    if (secretElement.textContent.includes('‚Ä¢')) {
      secretElement.textContent = secret;
      event.target.innerHTML = 'üôà';
    } else {
      secretElement.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      event.target.innerHTML = 'üëÅÔ∏è';
    }
  }
</script>

<style>
  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .admin-header h1 {
    font-size: 1.875rem;
    font-weight: 700;
    margin: 0;
    color: #111827;
  }

  .header-actions {
    display: flex;
    gap: 0.75rem;
  }

  .editor-details {
    display: grid;
    gap: 2rem;
  }

  .detail-section {
    background: white;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
    padding: 1.5rem;
  }

  .detail-section h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 1.5rem 0;
    color: #111827;
  }

  .detail-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }

  .detail-item {
    display: grid;
    gap: 0.25rem;
  }

  .detail-item label {
    font-weight: 600;
    color: #6b7280;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .detail-item span {
    color: #111827;
    font-size: 1rem;
  }

  .status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .status-success {
    background-color: #dcfce7;
    color: #166534;
  }

  .status-warning {
    background-color: #fef3c7;
    color: #92400e;
  }

  .oauth-details {
    display: grid;
    gap: 1.5rem;
  }

  .oauth-item {
    display: grid;
    gap: 0.5rem;
  }

  .oauth-item label {
    font-weight: 600;
    color: #374151;
  }

  .code-block {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    padding: 0.75rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  }

  .code-block code {
    flex: 1;
    background: none;
    padding: 0;
    color: #111827;
    font-size: 0.875rem;
  }

  .copy-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .copy-btn:hover {
    background-color: #e5e7eb;
  }

  .warning-text {
    color: #f59e0b;
    font-size: 0.875rem;
    font-style: italic;
  }

  .scopes-list {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .scope-badge {
    background-color: #dbeafe;
    color: #1e40af;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .oauth-missing {
    text-align: center;
    padding: 2rem;
  }

  .oauth-missing p {
    color: #6b7280;
    margin: 1rem 0;
  }

  .url-list {
    display: grid;
    gap: 1rem;
  }

  .url-item {
    display: grid;
    gap: 0.5rem;
  }

  .integration-example {
    margin-top: 2rem;
  }

  .integration-example h4 {
    font-weight: 600;
    margin-bottom: 1rem;
    color: #374151;
  }

  .code-example {
    display: block;
    overflow-x: auto;
  }

  .code-example pre {
    margin: 0;
    font-size: 0.875rem;
    line-height: 1.5;
    color: #111827;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem;
  }

  .stat-item {
    text-align: center;
    padding: 1rem;
    background-color: #f9fafb;
    border-radius: 0.5rem;
  }

  .stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: #2563eb;
  }

  .stat-label {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }

  .email-link, .external-link {
    color: #2563eb;
    text-decoration: none;
  }

  .email-link:hover, .external-link:hover {
    text-decoration: underline;
  }

  .btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    text-decoration: none;
    font-weight: 500;
    text-align: center;
    border: 1px solid transparent;
    cursor: pointer;
  }

  .btn-primary {
    background-color: #2563eb;
    color: white;
  }

  .btn-outline-primary {
    border-color: #2563eb;
    color: #2563eb;
    background: white;
  }

  .btn-outline-secondary {
    border-color: #6b7280;
    color: #6b7280;
    background: white;
  }
</style>